{"version":3,"file":"show-call-counts.js","sources":["../../src/lib/html.ts","../../src/lib/device.ts","../../src/lib/raf.ts","../../src/scripts/show-call-counts.ts"],"sourcesContent":["\nexport function addElementToWebgpuDevExtension(elem: HTMLElement) {\n  const webgpuDevExtensionElemId = 'webgpu-dev-extension';\n  let webgpuDevExtensionElem = document.getElementById(webgpuDevExtensionElemId);\n  if (!webgpuDevExtensionElem) {\n    webgpuDevExtensionElem = document.createElement('div');\n    webgpuDevExtensionElem.id = webgpuDevExtensionElemId;\n\n    Object.assign(webgpuDevExtensionElem.style, {\n      margin: '0',\n      padding: '0.25em',\n      fontSize: '8px',\n      fontFamily: 'monospace',\n      color: '#fff',\n      backgroundColor: 'rgba(0,0,0,0.8)',\n      position: 'fixed',\n      left: '0',\n      bottom: '0',\n      zIndex: 1000000,\n    });\n\n\n    document.documentElement.append(webgpuDevExtensionElem);\n  }\n  webgpuDevExtensionElem.append(elem);\n}\n\ntype EventHandler = (...args: any) => any;\ntype JsonMLAttributeValue = string | number | boolean | null | JsonMLAttributes | EventHandler | undefined;\ninterface JsonMLAttributes {\n    [key: string]: JsonMLAttributeValue;\n}\ntype JsonMLTagName = string;\ntype JsonMLTextNode = string;\ntype JsonMLChild = JsonMLElement | JsonMLTextNode | Node;\n\ntype JsonMLElement =\n    | [JsonMLTagName] // Matches structure 1\n    | [JsonMLTagName, JsonMLAttributes] // Matches structure 2\n    | [JsonMLTagName, JsonMLAttributes, ...JsonMLChild[]] // Matches structure 3\n    | [JsonMLTagName, ...JsonMLChild[]] // Matches structure 4\n    | [Node]\n    ;\n\n//type JsonML = JsonMLElement | JsonMLTextNode | JsonMLChild[];\n\n/**\n * Implements JsonML *like* element creation (http://www.jsonml.org/)\n *\n * The major difference is this takes event handlers for `on` functions\n * and supports nested attributes? Also allows elements.\n */\nexport function makeElem(elemSpec: JsonMLElement) {\n  const tag = elemSpec[0];\n  if (tag instanceof Node) {\n    return tag;\n  }\n  const elem = document.createElement(tag);\n\n  let firstChildNdx = 1;\n  const firstChild = elemSpec[1];\n  // Check if it's attributes\n  if (!(firstChild instanceof Node) && typeof firstChild !== 'string' && !Array.isArray(firstChild)) {\n    firstChildNdx = 2;\n    const attributes = firstChild as JsonMLAttributes;\n    for (const [key, value] of Object.entries(attributes)) {\n      if (typeof value === 'function' && key.startsWith('on')) {\n        const eventName = key.substring(2).toLowerCase();\n        elem.addEventListener(eventName, value, {passive: false});\n      } else if (typeof value === 'object') {\n        for (const [k, v] of Object.entries(value as JsonMLAttributes)) {\n          // @ts-expect-error just do it!\n          elem[key][k] = v;\n        }\n      // @ts-expect-error just do it!\n      } else if (elem[key] === undefined) {\n        elem.setAttribute(key, value as string);\n      } else {\n        // @ts-expect-error just do it!\n        elem[key] = value;\n      }\n    }\n  }\n\n  for (let ndx = firstChildNdx; ndx < elemSpec.length; ++ndx) {\n    const v = elemSpec[ndx];\n    if (typeof v === 'string') {\n      elem.appendChild(document.createTextNode(v));\n    } else if (v instanceof Node) {\n      elem.appendChild(v);\n    } else {\n      elem.appendChild(makeElem(v as JsonMLElement));\n    }\n  }\n  return elem;\n}","\n\nexport function callbackWhenDevicesGoFrom0to1Or1To0(callback: (haveDevice: boolean) => void) {\n  const s_deviceRefs: WeakRef<GPUDevice>[] = [];\n\n  function removeGCed() {\n    const refs = s_deviceRefs.filter(ref => !!ref.deref());\n    s_deviceRefs.length = 0;\n    s_deviceRefs.push(...refs);\n  }\n\n  function checkDevices() {\n    removeGCed();\n    update();\n  }\n\n  let intervalId: number | undefined;\n  function update() {\n    removeGCed();\n\n    if (!intervalId) {\n      if (s_deviceRefs.length > 0) {\n        intervalId = setInterval(checkDevices, 1000);\n        callback(true);\n      }\n    } else {\n      if (s_deviceRefs.length === 0) {\n        clearInterval(intervalId);\n        intervalId = undefined;\n        callback(false);\n      }\n    }\n  }\n\n  GPUAdapter.prototype.requestDevice = (function(origFn) {\n    return async function(this: GPUAdapter, ...args) {\n      const device = await origFn.call(this, ...args);\n      if (device) {\n        s_deviceRefs.push(new WeakRef(device));\n        update();\n      }\n      return device;\n    };\n  })(GPUAdapter.prototype.requestDevice)\n\n  GPUDevice.prototype.destroy = (function(origFn) {\n    return function(this: GPUDevice) {\n      origFn.call(this);\n      const device = this;\n      const ndx = s_deviceRefs.findIndex(ref => ref.deref() === device);\n      s_deviceRefs.splice(ndx, 0);\n      update();\n    }\n  })(GPUDevice.prototype.destroy);\n}","\nimport { callbackWhenDevicesGoFrom0to1Or1To0 } from '../lib/device.js';\n\nexport function rafCallbackWhenDevicesExist(callback: () => void) {\n  let running: boolean;\n  let rafId: number | undefined;\n\n  function updateAndResetCount() {\n    rafId = undefined;\n\n    callback();\n\n    if (running) {\n      startRaf();\n    }\n  }\n\n  function startRaf() {\n    if (!rafId) {\n      rafId = requestAnimationFrame(updateAndResetCount);\n    }\n  }\n\n  function stopRaf() {\n    if (rafId) {\n      cancelAnimationFrame(rafId);\n      rafId = undefined;\n    }\n  }\n\n  callbackWhenDevicesGoFrom0to1Or1To0((haveDevices) => {\n    if (haveDevices) {\n      running = true;\n      startRaf();\n    } else {\n      stopRaf()\n    }\n  });\n\n}","import { addElementToWebgpuDevExtension } from '../lib/html.js';\nimport { rafCallbackWhenDevicesExist } from '../lib/raf.js';\n\n/* eslint-disable no-inner-declarations */\nif (typeof GPUDevice !== 'undefined') {\n  const s_counts = new Map<string, number>();\n\n  function addCount(name: string) {\n    s_counts.set(name, (s_counts.get(name) ?? 0) + 1);\n  }\n\n  // @ts-expect-error this code is difficult to type\n  function addCountWrapper(API, apiName, methodName, origFn) {\n    const name = `${apiName}.${methodName}`;\n    // @ts-expect-error this code is difficult to type\n    API.prototype[methodName] = function (...args) {\n      addCount(name);\n      return origFn.call(this, ...args);\n    };\n  }\n\n  const APIs = [\n    GPU,\n    GPUAdapter,\n    GPUBuffer,\n    GPUCanvasContext,\n    GPUCommandEncoder,\n    GPUComputePassEncoder,\n    GPUDevice,\n    GPUQueue,\n    GPUQuerySet,\n    GPURenderBundleEncoder,\n    GPURenderPassEncoder,\n    GPUTexture,\n  ];\n\n  for (const API of APIs) {\n    const apiName = API.prototype.constructor.name;\n    const prototype = API.prototype;\n    const methodNames = Object.entries(Object.getOwnPropertyDescriptors(prototype))\n        .filter(([, v]) => v.writable && v.enumerable && v.configurable && typeof v.value === 'function')\n        .map(([k]) => k);\n    for (const name of methodNames) {\n      // @ts-expect-error this code is difficult to type\n      addCountWrapper(API, apiName, name, API.prototype[name]);\n    }\n  }\n\n  const baseElem = document.createElement('details');\n  const summaryElem = document.createElement('summary');\n  const infoElem = document.createElement('pre');\n\n  const summaryContentElem = document.createElement('span');\n  Object.assign(summaryContentElem.style, {\n    cursor: 'pointer',\n  });\n\n  const resetElem = document.createElement('span');\n  Object.assign(resetElem.style, {\n    marginLeft: '0.5em',\n    cursor: 'pointer',\n    title: 'remove zero count',\n  });\n  resetElem.textContent = 'ðŸ”„';\n  resetElem.addEventListener('click', e => {\n    e.preventDefault();\n    e.stopPropagation();\n    s_counts.clear();\n    return false;\n  }, { passive: false });\n\n  baseElem.append(summaryElem);\n  baseElem.append(infoElem);\n  summaryElem.append(summaryContentElem);\n  summaryElem.append(resetElem);\n\n  addElementToWebgpuDevExtension(baseElem);\n\n  function updateAndResetCount() {\n    let total = 0;\n    const calls: string[] = [];\n    s_counts.forEach((v, k) => {\n      total += v;\n      calls.push(`${k}: ${v}`);\n      s_counts.set(k, 0);\n    });\n    calls.sort();\n    infoElem.textContent = calls.join('\\n');\n    summaryContentElem.textContent = `cpf: ${total}`;\n  }\n\n  rafCallbackWhenDevicesExist(updateAndResetCount);\n}\n\ndocument.currentScript?.remove();\n"],"names":[],"mappings":"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"}