{"version":3,"file":"raf-skip-frames.js","sources":["../../src/scripts/raf-skip-frames.js"],"sourcesContent":["{\n  const log = (...args) => {\n    // console.log(...args);\n  };\n\n  let settings;\n  {\n    document.addEventListener('webgpu-dev-extension-settings', (event) => {\n      // Handle data from event.detail\n      log('got special event:', event);\n      settings = event.detail;\n    }, { once: true });\n    log('sent message');\n    document.dispatchEvent(new CustomEvent('webgpu-dev-extension-event', {\n      detail: {\n        cmd: 'getSettings',\n      },\n    }));\n  }\n\n  function getRafSkipFrames() {\n    return settings?.rafSkipFrames ?? 0;\n  }\n\n  function getTimeMult() {\n    return settings?.timeMult ?? 1;\n  }\n\n  const origRAF = window.requestAnimationFrame.bind(window);\n\n  let frameCount = 0;\n  let id = 0;\n  let currentId = 0;\n  let callbacks = new Map();\n  let processingCallbacks = new Map();;\n\n  function process(time) {\n    currentId = 0;\n    --frameCount;\n    if (frameCount >= 0) {\n      currentId = origRAF(process);\n      return;\n    }\n\n    frameCount = getRafSkipFrames();\n    processingCallbacks = callbacks;\n    callbacks = new Map();\n\n    const ids = [...processingCallbacks.keys()];\n    for (const id of ids) {\n      const cb = processingCallbacks.get(id);\n      if (cb) {\n        processingCallbacks.delete(id);\n        try {\n          cb(time *  getTimeMult());\n        } catch (e) {\n          console.error(e);\n        }\n      }\n    }\n  }\n\n  performance.now = (function(origFn) {\n    return function() {\n      const now = origFn.call(this) *  getTimeMult();\n      return now;\n    };\n  })(performance.now);\n\n  // I'm not sure if this is a good idea or not. I've seen apps that user\n  // Date.now for animation. One issue those is `Date.now()` will not match\n  // `new Date().valueOf()`\n  Date.now = (function(origFn) {\n    return function() {\n      const now = origFn.call(this) - (performance.now() | 0);\n      //console.log('Date.now():', now);\n      return now;\n    };\n  })(Date.now);\n\n  window.setTimeout = (function(origFn) {\n    return function(callback, duration, ...args) {\n      const d = (duration ?? 0) *  getTimeMult();\n      return origFn.call(this, callback, d, ...args);\n    };\n  })(window.setTimeout);\n\n  window.setInterval = (function(origFn) {\n    return function(callback, duration, ...args) {\n      const d = (duration ?? 0) *  getTimeMult();\n      return origFn.call(this, callback, d, ...args);\n    };\n  })(window.setInterval);\n\n  window.requestAnimationFrame = (function(origFn) {\n    return function(callback) {\n      ++id;\n      callbacks.set(id, callback);\n      if (!currentId) {\n        origFn(process);\n      }\n      return id;\n    };\n  })(window.requestAnimationFrame);\n\n  window.cancelAnimationFrame = (function(origFn) {\n    return function(id) {\n      callbacks.delete(id);\n      processingCallbacks.delete(id);\n    };\n  })(window.cancelAnimationFrame);\n}\n\ndocument.currentScript?.remove();\n"],"names":[],"mappings":";;;;EAAA;;EAKA,EAAE,IAAI,QAAQ;EACd,EAAE;EACF,IAAI,QAAQ,CAAC,gBAAgB,CAAC,+BAA+B,EAAE,CAAC,KAAK,KAAK;EAG1E,MAAM,QAAQ,GAAG,KAAK,CAAC,MAAM;EAC7B,KAAK,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;EAEtB,IAAI,QAAQ,CAAC,aAAa,CAAC,IAAI,WAAW,CAAC,4BAA4B,EAAE;EACzE,MAAM,MAAM,EAAE;EACd,QAAQ,GAAG,EAAE,aAAa;EAC1B,OAAO;EACP,KAAK,CAAC,CAAC;EACP;;EAEA,EAAE,SAAS,gBAAgB,GAAG;EAC9B,IAAI,OAAO,QAAQ,EAAE,aAAa,IAAI,CAAC;EACvC;;EAEA,EAAE,SAAS,WAAW,GAAG;EACzB,IAAI,OAAO,QAAQ,EAAE,QAAQ,IAAI,CAAC;EAClC;;EAEA,EAAE,MAAM,OAAO,GAAG,MAAM,CAAC,qBAAqB,CAAC,IAAI,CAAC,MAAM,CAAC;;EAE3D,EAAE,IAAI,UAAU,GAAG,CAAC;EACpB,EAAE,IAAI,EAAE,GAAG,CAAC;EACZ,EAAE,IAAI,SAAS,GAAG,CAAC;EACnB,EAAE,IAAI,SAAS,GAAG,IAAI,GAAG,EAAE;EAC3B,EAAE,IAAI,mBAAmB,GAAG,IAAI,GAAG,EAAE;EAErC,EAAE,SAAS,OAAO,CAAC,IAAI,EAAE;EACzB,IAAI,SAAS,GAAG,CAAC;EACjB,IAAI,EAAE,UAAU;EAChB,IAAI,IAAI,UAAU,IAAI,CAAC,EAAE;EACzB,MAAM,SAAS,GAAG,OAAO,CAAC,OAAO,CAAC;EAClC,MAAM;EACN;;EAEA,IAAI,UAAU,GAAG,gBAAgB,EAAE;EACnC,IAAI,mBAAmB,GAAG,SAAS;EACnC,IAAI,SAAS,GAAG,IAAI,GAAG,EAAE;;EAEzB,IAAI,MAAM,GAAG,GAAG,CAAC,GAAG,mBAAmB,CAAC,IAAI,EAAE,CAAC;EAC/C,IAAI,KAAK,MAAM,EAAE,IAAI,GAAG,EAAE;EAC1B,MAAM,MAAM,EAAE,GAAG,mBAAmB,CAAC,GAAG,CAAC,EAAE,CAAC;EAC5C,MAAM,IAAI,EAAE,EAAE;EACd,QAAQ,mBAAmB,CAAC,MAAM,CAAC,EAAE,CAAC;EACtC,QAAQ,IAAI;EACZ,UAAU,EAAE,CAAC,IAAI,IAAI,WAAW,EAAE,CAAC;EACnC,SAAS,CAAC,OAAO,CAAC,EAAE;EACpB,UAAU,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC;EAC1B;EACA;EACA;EACA;;EAEA,EAAE,WAAW,CAAC,GAAG,GAAG,CAAC,SAAS,MAAM,EAAE;EACtC,IAAI,OAAO,WAAW;EACtB,MAAM,MAAM,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,WAAW,EAAE;EACpD,MAAM,OAAO,GAAG;EAChB,KAAK;EACL,GAAG,EAAE,WAAW,CAAC,GAAG,CAAC;;EAErB;EACA;EACA;EACA,EAAE,IAAI,CAAC,GAAG,GAAG,CAAC,SAAS,MAAM,EAAE;EAC/B,IAAI,OAAO,WAAW;EACtB,MAAM,MAAM,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,WAAW,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;EAC7D;EACA,MAAM,OAAO,GAAG;EAChB,KAAK;EACL,GAAG,EAAE,IAAI,CAAC,GAAG,CAAC;;EAEd,EAAE,MAAM,CAAC,UAAU,GAAG,CAAC,SAAS,MAAM,EAAE;EACxC,IAAI,OAAO,SAAS,QAAQ,EAAE,QAAQ,EAAE,GAAG,IAAI,EAAE;EACjD,MAAM,MAAM,CAAC,GAAG,CAAC,QAAQ,IAAI,CAAC,KAAK,WAAW,EAAE;EAChD,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,QAAQ,EAAE,CAAC,EAAE,GAAG,IAAI,CAAC;EACpD,KAAK;EACL,GAAG,EAAE,MAAM,CAAC,UAAU,CAAC;;EAEvB,EAAE,MAAM,CAAC,WAAW,GAAG,CAAC,SAAS,MAAM,EAAE;EACzC,IAAI,OAAO,SAAS,QAAQ,EAAE,QAAQ,EAAE,GAAG,IAAI,EAAE;EACjD,MAAM,MAAM,CAAC,GAAG,CAAC,QAAQ,IAAI,CAAC,KAAK,WAAW,EAAE;EAChD,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,QAAQ,EAAE,CAAC,EAAE,GAAG,IAAI,CAAC;EACpD,KAAK;EACL,GAAG,EAAE,MAAM,CAAC,WAAW,CAAC;;EAExB,EAAE,MAAM,CAAC,qBAAqB,GAAG,CAAC,SAAS,MAAM,EAAE;EACnD,IAAI,OAAO,SAAS,QAAQ,EAAE;EAC9B,MAAM,EAAE,EAAE;EACV,MAAM,SAAS,CAAC,GAAG,CAAC,EAAE,EAAE,QAAQ,CAAC;EACjC,MAAM,IAAI,CAAC,SAAS,EAAE;EACtB,QAAQ,MAAM,CAAC,OAAO,CAAC;EACvB;EACA,MAAM,OAAO,EAAE;EACf,KAAK;EACL,GAAG,EAAE,MAAM,CAAC,qBAAqB,CAAC;;EAElC,EAAE,MAAM,CAAC,oBAAoB,GAAG,CAAC,SAAS,MAAM,EAAE;EAClD,IAAI,OAAO,SAAS,EAAE,EAAE;EACxB,MAAM,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC;EAC1B,MAAM,mBAAmB,CAAC,MAAM,CAAC,EAAE,CAAC;EACpC,KAAK;EACL,GAAG,EAA6B,CAAC;EACjC;;EAEA,QAAQ,CAAC,aAAa,EAAE,MAAM,EAAE;;;;;;"}