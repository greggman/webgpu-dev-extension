{"version":3,"file":"block-features.js","sources":["../../src/scripts/block-features.js"],"sourcesContent":["if (typeof GPUAdapter !== 'undefined') {\n  const log = (...args) => {\n    // console.log(...args);\n  };\n\n  const settingsPromise = new Promise((resolve, reject) => {\n    document.addEventListener('webgpu-dev-extension-settings', (event) => {\n      // Handle data from event.detail\n      log('got special event:', event);\n      resolve(event.detail);\n    }, { once: true });\n    log('sent message');\n    document.dispatchEvent(new CustomEvent('webgpu-dev-extension-event', {\n      detail: {\n        cmd: 'getSettings',\n      },\n    }));\n  });\n\n  async function getIsBlocked() {\n    const settings = await settingsPromise;\n    log('got settings:', settings);\n    const blockFeatureStrings = (settings.blockFeatures || '').split(/[,\\s]+/).map(v => v.trim());\n    const blockFeatureREs = blockFeatureStrings.map(v => new RegExp(`^${v.replaceAll('*', '.*')}$`));\n    if (blockFeatureStrings.length > 0) {\n      console.log('blocking WebGPU Features:', blockFeatureStrings.join(', '));\n    }\n\n    const isBlocked = (feature) => {\n      for (const re of blockFeatureREs) {\n        if (re.test(feature)) {\n          return true;\n        }\n      }\n      return false;\n    }\n    return isBlocked;\n  }\n\n  GPU.prototype.requestAdapter = (function (origFn) {\n    return async function (desc) {\n      log('wait for get is blocked');\n      const isBlocked = await getIsBlocked();\n      log('got is blocked');\n      const adapter = await origFn.call(this, desc);\n      log('requested adapter');\n      if (adapter) {\n        Object.defineProperty(adapter, 'features', {\n          value: new Set([...adapter.features].filter(feature => {\n            const blocked = isBlocked(feature);\n            if (blocked) {\n              console.log('blocked WebGPU feature:', feature);\n            }\n            return !blocked;\n          })),\n        });\n      }\n      return adapter;\n    };\n  })(GPU.prototype.requestAdapter);\n\n  GPUAdapter.prototype.requestDevice = (function (origFn) {\n    return async function (desc) {\n      const isBlocked = await getIsBlocked();\n      if (desc && desc.requiredFeatures) {\n        for (const feature of desc.requiredFeatures) {\n          if (isBlocked(feature)) {\n            throw new Error(`${feature} unsupported (blocked by extension)`);\n          }\n        }\n      }\n      return await origFn.call(this, desc);\n    };\n  })(GPUAdapter.prototype.requestDevice);\n}\n\ndocument.currentScript?.remove();\n"],"names":[],"mappings":"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"}