{"version":3,"file":"enforce-default-limits.js","sources":["../../src/scripts/enforce-default-limits.js"],"sourcesContent":["\nif (typeof GPU !== 'undefined') {\n  console.log('webgpu-dev-extension: enforce-default-limits');\n  function objLikeToObj(objLike) {\n    const obj = {};\n    for (const key in objLike) {\n      obj[key] = objLike[key];\n    }\n    return obj;\n  }\n\n  const s_adapterToLimits = new WeakMap();\n  const gpuAdapterPrototypeDescriptors = Object.getOwnPropertyDescriptors(GPUAdapter.prototype);\n\n  // We can't just set `limits` on the adapter because it's actually a getter.\n  // So, override the getter.\n  Object.defineProperty(GPUAdapter.prototype, 'limits', {\n    get() {\n      const limits = s_adapterToLimits.get(this) ?? gpuAdapterPrototypeDescriptors.limits.get.call(this);\n      return limits;\n    },\n  });\n\n  function enforceDefaultLimits(adapter/*: GPUAdapter*/, desc/*: GPUDeviceDescriptor | undefined*/) {\n    if (desc?.requiredLimits) {\n      const limits = s_adapterToLimits.get(adapter);\n      for (const [key, value] of Object.entries(desc.requiredLimits)) {\n        const limit = limits[key];\n        if (limit !== undefined && value !== undefined) {\n          const [beyondLimit, condition] = key.startsWith('max')\n            ? [value > limit, 'greater']\n            : [value < limit, 'less'];\n          if (beyondLimit) {\n            throw new DOMException(\n              `requestedLimit ${value} for ${key} is ${condition} than adapter limit ${limit}`,\n              'OperationError'\n            );\n          }\n        }\n      }\n    }\n  };\n\n  const origRequestAdapter = GPU.prototype.requestAdapter;\n  const origRequestDevice = GPUAdapter.prototype.requestDevice;\n\n  async function getDefaultLimits(desc) {\n    let defaultLimits;\n    try {\n      const tempAdapter = await origRequestAdapter.call(navigator.gpu, desc);\n      const tempDevice = await origRequestDevice.call(tempAdapter);\n      defaultLimits = objLikeToObj(tempDevice.limits);\n      tempDevice.destroy();\n    } catch (e) {\n      //\n    }\n    return defaultLimits;\n  }\n\n  GPU.prototype.requestAdapter = async function(desc = {}) {\n    const limits = await getDefaultLimits(desc);\n    const adapter = await origRequestAdapter.call(this, desc);\n    if (adapter && limits) {\n      s_adapterToLimits.set(adapter, limits);\n    }\n    return adapter;\n  }\n\n  GPUAdapter.prototype.requestDevice = async function(desc = {}) {\n    enforceDefaultLimits(this, desc);\n    return await origRequestDevice.call(this, desc);\n  };\n}\n\ndocument.currentScript?.remove();\n"],"names":[],"mappings":"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"}