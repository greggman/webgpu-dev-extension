{"version":3,"file":"show-errors.js","sources":["../../src/scripts/show-errors.js"],"sourcesContent":["/* show-errors@0.2.2, license MIT */\n(function (factory) {\n    typeof define === 'function' && define.amd ? define(factory) :\n    factory();\n})((function () { 'use strict';\n\n    const s_objToDevice = new WeakMap();\n\n    /* eslint-disable no-inner-declarations */\n    if (typeof GPUDevice !== 'undefined') {\n        const deviceToErrorScopeStack = new WeakMap();\n        const origPushErrorScope = GPUDevice.prototype.pushErrorScope;\n        const origPopErrorScope = GPUDevice.prototype.popErrorScope;\n        function errorWrapper(device, fnName, origFn, ...args) {\n            const stack = new Error();\n            origPushErrorScope.call(device, 'validation');\n            const result = origFn.call(this, ...args);\n            const errorScopeStack = deviceToErrorScopeStack.get(device);\n            const currentErrorScope = errorScopeStack.findLast(scope => scope.filter === 'validation');\n            const promise = origPopErrorScope.call(device)\n                .then(error => {\n                // If there was a currentErrorScope and there was no error the remove our promise.\n                if (currentErrorScope) {\n                    if (!error) {\n                        const ndx = currentErrorScope.errors.indexOf(promise);\n                        if (ndx) {\n                            currentErrorScope.errors.splice(ndx, 1);\n                        }\n                    }\n                }\n                else {\n                    // there was no currentErrorScope so emit the error\n                    if (error) {\n                        device.dispatchEvent(new GPUUncapturedErrorEvent('uncapturederror', { error }));\n                    }\n                }\n                // show it\n                if (error) {\n                    console.error('WebGPU ERROR in:', fnName, args);\n                    console.error(error.message);\n                    console.error(stack.stack);\n                }\n                // return it (as a promise)\n                return error;\n            });\n            if (currentErrorScope) {\n                currentErrorScope.errors.push(promise);\n            }\n            return result;\n        }\n        function debugGroupWrapper(device, fnName, origFn, ...args) {\n            this.pushDebugGroup(`${fnName}:\\n${new Error().stack}`);\n            const result = origFn.call(this, ...args);\n            this.popDebugGroup();\n            return result;\n        }\n        function addErrorWrapper(api, fnName) {\n            const origFn = api.prototype[fnName];\n            api.prototype[fnName] = function (...args) {\n                return errorWrapper.call(this, this, fnName.toString(), origFn, ...args);\n            };\n        }\n        function addErrorWrapperWithDevice(api, fnName) {\n            const origFn = api.prototype[fnName];\n            api.prototype[fnName] = function (...args) {\n                const device = s_objToDevice.get(this);\n                return errorWrapper.call(this, device, fnName.toString(), origFn, ...args);\n            };\n        }\n        function addDebugGroupWrapper(api, fnName) {\n            const origFn = api.prototype[fnName];\n            api.prototype[fnName] = function (...args) {\n                return debugGroupWrapper.call(this, this, fnName.toString(), origFn, ...args);\n            };\n        }\n        /**\n         * given a class returns all the method names.\n         */\n        function getAPIFunctionNames(api) {\n            return Object.entries(Object.getOwnPropertyDescriptors(api.prototype))\n                .filter(([, info]) => info.enumerable && typeof info.value === 'function')\n                .map(([name]) => name);\n        }\n        {\n            const skip = new Set([\n                'pushErrorScope',\n                'popErrorScope',\n                'destroy',\n            ]);\n            getAPIFunctionNames(GPUDevice)\n                .filter(n => !skip.has(n))\n                .forEach(n => addErrorWrapper(GPUDevice, n));\n            getAPIFunctionNames(GPUQueue)\n                .forEach(n => addErrorWrapperWithDevice(GPUQueue, n));\n        }\n        {\n            const skip = new Set(['pushDebugGroup', 'popDebugGroup', 'finish', 'end']);\n            getAPIFunctionNames(GPUCommandEncoder)\n                .filter(n => !skip.has(n))\n                .forEach(n => addDebugGroupWrapper(GPUCommandEncoder, n));\n            getAPIFunctionNames(GPUComputePassEncoder)\n                .filter(n => !skip.has(n))\n                .forEach(n => addDebugGroupWrapper(GPUComputePassEncoder, n));\n            getAPIFunctionNames(GPURenderPassEncoder)\n                .filter(n => !skip.has(n))\n                .forEach(n => addDebugGroupWrapper(GPURenderPassEncoder, n));\n            getAPIFunctionNames(GPURenderBundleEncoder)\n                .filter(n => !skip.has(n))\n                .forEach(n => addDebugGroupWrapper(GPURenderBundleEncoder, n));\n        }\n        GPUDevice.prototype.pushErrorScope = (function (origFn) {\n            return function (filter) {\n                origFn.call(this, filter);\n                const errorScopeStack = deviceToErrorScopeStack.get(this);\n                errorScopeStack.push({ filter, errors: [] });\n            };\n        })(GPUDevice.prototype.pushErrorScope);\n        GPUDevice.prototype.popErrorScope = (function (origFn) {\n            return async function () {\n                const errorScopeStack = deviceToErrorScopeStack.get(this);\n                const errorScope = errorScopeStack.pop();\n                if (errorScope === undefined) {\n                    throw new DOMException('popErrorScope called on empty error scope stack', 'OperationError');\n                }\n                const errPromise = origFn.call(this);\n                errorScope.errors.push(errPromise);\n                const errors = await Promise.all(errorScope.errors);\n                const error = errors.find(v => !!v);\n                return error ?? null;\n            };\n        })(GPUDevice.prototype.popErrorScope);\n        GPUAdapter.prototype.requestDevice = (function (origFn) {\n            return async function (...args) {\n                const device = await origFn.call(this, ...args);\n                if (device) {\n                    device.addEventListener('uncapturederror', function (e) {\n                        console.error(e.error.message);\n                    });\n                    deviceToErrorScopeStack.set(device, []);\n                    s_objToDevice.set(device.queue, device);\n                }\n                return device;\n            };\n        })(GPUAdapter.prototype.requestDevice);\n    }\n\n}));\n"],"names":[],"mappings":"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"}